// eventHandlers.js - Manejo de eventos con versiones agrupadas

import { ExcelExporter } from './excelExporter.js';
import { ExcelImporter } from './excelImporter.js';
import { Modal } from './modal.js';
import { Validator } from './validator.js';

export class EventHandlers {
    constructor(dataStore, renderer) {
        this.dataStore = dataStore;
        this.renderer = renderer;
    }

    setupEventListeners() {
        this.setupThemeToggle();
        this.setupSearchToggle();
        this.setupAgregarButton();
        this.setupNuevaVersionLimpiaButton();
        this.setupDuplicarVersionButton();
        this.setupCargarButton();
        this.setupDescargarButton();
        this.setupTablaEvents();
        this.setupFilterEvents();
        
        console.log('‚úÖ Event listeners configurados correctamente');
    }

    setupSearchToggle() {
        const btnToggle = document.getElementById('btn-toggle-search');
        const filtersSection = document.querySelector('.filters-section');
        
        btnToggle.addEventListener('click', () => {
            const isCollapsed = filtersSection.classList.contains('filters-collapsed');
            
            if (isCollapsed) {
                // Expandir
                filtersSection.classList.remove('filters-collapsed');
                btnToggle.classList.add('active');
            } else {
                // Colapsar
                filtersSection.classList.add('filters-collapsed');
                btnToggle.classList.remove('active');
            }
        });
        
        console.log('‚úÖ Toggle de b√∫squeda configurado');
    }

    setupThemeToggle() {
        const btnTheme = document.getElementById('btn-theme-toggle');
        const sunIcon = `<svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <circle cx="12" cy="12" r="5"></circle>
            <line x1="12" y1="1" x2="12" y2="3"></line>
            <line x1="12" y1="21" x2="12" y2="23"></line>
            <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
            <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
            <line x1="1" y1="12" x2="3" y2="12"></line>
            <line x1="21" y1="12" x2="23" y2="12"></line>
            <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
            <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
        </svg>`;
        const moonIcon = `<svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
        </svg>`;

        // Cargar tema guardado
        const savedTheme = localStorage.getItem('theme') || 'light';
        document.documentElement.setAttribute('data-theme', savedTheme);
        btnTheme.innerHTML = savedTheme === 'dark' ? sunIcon : moonIcon;

        btnTheme.addEventListener('click', () => {
            const currentTheme = document.documentElement.getAttribute('data-theme');
            const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
            
            document.documentElement.setAttribute('data-theme', newTheme);
            localStorage.setItem('theme', newTheme);
            btnTheme.innerHTML = newTheme === 'dark' ? sunIcon : moonIcon;
        });
    }

    setupAgregarButton() {
        const btn = document.getElementById('btn-agregar');
        if (!btn) {
            console.error('‚ùå No se encontr√≥ el bot√≥n btn-agregar');
            return;
        }
        
        btn.addEventListener('click', () => {
            console.log('üîò Click en Nuevo CDU');
            this.dataStore.addCduToLatestVersion();
            this.renderer.fullRender();
        });
        
        console.log('‚úÖ Bot√≥n "Nuevo CDU" configurado');
    }

    setupNuevaVersionLimpiaButton() {
        const btn = document.getElementById('btn-nueva-version-limpia');
        if (!btn) {
            console.error('‚ùå No se encontr√≥ el bot√≥n btn-nueva-version-limpia');
            return;
        }
        
        btn.addEventListener('click', async () => {
            console.log('üîò Click en Nueva Versi√≥n Limpia');
            const version = this.dataStore.addNewEmptyVersion();
            await Modal.success(
                `Versi√≥n ${version.numero} creada. Ahora puedes agregar CDUs con el bot√≥n "Nuevo CDU".`,
                'Versi√≥n Creada'
            );
            this.renderer.fullRender();
        });
        
        console.log('‚úÖ Bot√≥n "Nueva Versi√≥n Limpia" configurado');
    }

    setupDuplicarVersionButton() {
        const btn = document.getElementById('btn-duplicar-version');
        if (!btn) {
            console.error('‚ùå No se encontr√≥ el bot√≥n btn-duplicar-version');
            return;
        }
        
        btn.addEventListener('click', async () => {
            console.log('üîò Click en Duplicar √öltima Versi√≥n');
            const versiones = this.dataStore.getAll();
            
            if (versiones.length === 0) {
                await Modal.warning(
                    'No hay versiones para duplicar. Crea una nueva versi√≥n primero.',
                    'Sin Versiones'
                );
                return;
            }
            
            // Duplicar la √∫ltima versi√≥n
            const ultimaVersion = versiones[versiones.length - 1];
            const nuevaVersion = this.dataStore.duplicateVersion(ultimaVersion.id);
            
            await Modal.success(
                `Versi√≥n ${nuevaVersion.numero} creada como copia de la versi√≥n ${ultimaVersion.numero} con ${nuevaVersion.cdus.length} CDUs.`,
                'Versi√≥n Duplicada'
            );
            this.renderer.fullRender();
        });
        
        console.log('‚úÖ Bot√≥n "Duplicar √öltima Versi√≥n" configurado');
    }

    setupCargarButton() {
        const btnCargar = document.getElementById('btn-cargar');
        const fileInput = document.getElementById('file-input');

        btnCargar.addEventListener('click', () => {
            fileInput.click();
        });

        fileInput.addEventListener('change', async (e) => {
            const file = e.target.files[0];
            if (!file) return;

            try {
                const versiones = await ExcelImporter.importar(file);
                
                if (versiones.length === 0) {
                    await Modal.error('No se encontraron datos v√°lidos en el archivo', 'Error de Importaci√≥n');
                    return;
                }

                let totalCdus = 0;
                versiones.forEach(v => totalCdus += v.cdus.length);

                const confirmacion = await Modal.confirm(
                    `Se encontraron ${versiones.length} versiones con ${totalCdus} CDUs.\n¬øDesea reemplazar los datos actuales?`,
                    'Confirmar Importaci√≥n'
                );

                if (confirmacion) {
                    this.dataStore.replaceAll(versiones);
                    this.renderer.fullRender();
                    await Modal.success('Datos cargados exitosamente', 'Importaci√≥n Exitosa');
                }
            } catch (error) {
                await Modal.error('Error al cargar el archivo: ' + error.message, 'Error');
                console.error(error);
            } finally {
                fileInput.value = '';
            }
        });
    }

    setupDescargarButton() {
        document.getElementById('btn-descargar').addEventListener('click', async () => {
            // Validar antes de descargar
            const versiones = this.dataStore.getAll();
            const validation = Validator.validateAllVersions(versiones);
            
            if (!validation.isValid) {
                const report = Validator.generateValidationReport(validation);
                const confirmacion = await Modal.confirm(
                    `${report}\n¬øDesea descargar de todos modos?`,
                    'Advertencia de Validaci√≥n'
                );
                
                if (!confirmacion) {
                    return;
                }
            }
            
            ExcelExporter.exportar(versiones);
        });
    }

    setupTablaEvents() {
        const tbody = document.getElementById('tabla-body');
        
        // Evento para actualizar datos cuando se editan campos
        tbody.addEventListener('input', (e) => {
            const campo = e.target.dataset.campo;
            if (!campo) return;
            
            const valor = e.target.value;
            
            // Verificar si es un campo de versi√≥n, CDU u observaci√≥n
            if (e.target.dataset.versionId) {
                const versionId = parseInt(e.target.dataset.versionId);
                this.dataStore.updateVersion(versionId, campo, valor);
            } else if (campo === 'observacion') {
                const cduId = parseInt(e.target.dataset.cduId);
                const obsIndex = parseInt(e.target.dataset.obsIndex);
                this.dataStore.updateObservacion(cduId, obsIndex, valor);
            } else if (e.target.dataset.cduId) {
                const cduId = parseInt(e.target.dataset.cduId);
                this.dataStore.updateCdu(cduId, campo, valor);
            }
        });

        // Evento para eliminar versiones o CDUs, y gestionar observaciones
        tbody.addEventListener('click', async (e) => {
            // Eliminar CDU o versi√≥n
            const btnEliminar = e.target.closest('.btn-eliminar');
            if (btnEliminar) {
                const versionId = btnEliminar.dataset.versionId;
                const cduId = btnEliminar.dataset.cduId;
                
                if (versionId) {
                    // Eliminar versi√≥n completa
                    const confirmacion = await Modal.confirm(
                        '¬øEst√° seguro de eliminar esta versi√≥n completa con todos sus CDUs?',
                        'Confirmar Eliminaci√≥n'
                    );
                    if (confirmacion) {
                        this.dataStore.deleteVersion(parseInt(versionId));
                        this.renderer.fullRender();
                    }
                } else if (cduId) {
                    // Eliminar solo el CDU
                    const confirmacion = await Modal.confirm(
                        '¬øEst√° seguro de eliminar este CDU?',
                        'Confirmar Eliminaci√≥n'
                    );
                    if (confirmacion) {
                        this.dataStore.deleteCdu(parseInt(cduId));
                        this.renderer.fullRender();
                    }
                }
                return;
            }
            
            // Agregar observaci√≥n
            const btnAdd = e.target.closest('[data-action="add-observacion"]');
            if (btnAdd) {
                const cduId = parseInt(btnAdd.dataset.cduId);
                this.dataStore.addObservacion(cduId, '');
                this.renderer.fullRender();
                
                // Enfocar el nuevo campo
                setTimeout(() => {
                    const container = document.querySelector(`[data-cdu-id="${cduId}"].observaciones-container`);
                    if (container) {
                        const inputs = container.querySelectorAll('input[data-campo="observacion"]');
                        const lastInput = inputs[inputs.length - 1];
                        if (lastInput) lastInput.focus();
                    }
                }, 100);
                return;
            }
            
            // Eliminar observaci√≥n
            const btnRemove = e.target.closest('[data-action="remove-observacion"]');
            if (btnRemove) {
                const cduId = parseInt(btnRemove.dataset.cduId);
                const obsIndex = parseInt(btnRemove.dataset.obsIndex);
                
                const confirmacion = await Modal.confirm(
                    '¬øEliminar esta observaci√≥n?',
                    'Confirmar'
                );
                if (confirmacion) {
                    this.dataStore.deleteObservacion(cduId, obsIndex);
                    this.renderer.fullRender();
                }
                return;
            }
        });
    }

    setupFilterEvents() {
        // B√∫squeda general
        const filterSearch = document.getElementById('filter-search');
        filterSearch.addEventListener('input', (e) => {
            this.renderer.setFilters({ search: e.target.value });
        });

        // Filtro de estado
        const filterEstado = document.getElementById('filter-estado');
        filterEstado.addEventListener('change', (e) => {
            this.renderer.setFilters({ estado: e.target.value });
        });

        // Filtro de responsable
        const filterResponsable = document.getElementById('filter-responsable');
        filterResponsable.addEventListener('input', (e) => {
            this.renderer.setFilters({ responsable: e.target.value });
        });

        // Filtro de fecha desde
        const filterFechaDesde = document.getElementById('filter-fecha-desde');
        filterFechaDesde.addEventListener('change', (e) => {
            this.renderer.setFilters({ fechaDesde: e.target.value });
        });

        // Filtro de fecha hasta
        const filterFechaHasta = document.getElementById('filter-fecha-hasta');
        filterFechaHasta.addEventListener('change', (e) => {
            this.renderer.setFilters({ fechaHasta: e.target.value });
        });

        // Bot√≥n de limpiar filtros
        const btnClearFilters = document.getElementById('btn-clear-filters');
        btnClearFilters.addEventListener('click', () => {
            this.renderer.clearFilters();
        });

        console.log('‚úÖ Event listeners de filtros configurados');
    }
}